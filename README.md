# API для управления библиотекой

## Архитектура приложения

Приложение построено на основе микросервисной архитектуры, что позволяет разделять функциональность на независимые 
модули, каждый из которых отвечает за свою область. Это обеспечивает гибкость, масштабируемость и упрощает процесс 
разработки и развертывания. Основные модули приложения включают:

### 1. Модули приложения

#### 1.1. Модуль `auth`

- **Функциональность**: 
  - Обеспечивает аутентификацию и авторизацию пользователей с использованием JWT-токенов.
  - Управляет пользователями и их правами доступа.

- **Основные API-маршруты**:
  - Достук к API просмотра списка пользователей только для администраторов.  
  
  - `/auth`: Регистрация, аутентификация пользователя и получение JWT-токенов.
  - `/users`: Просмотр списка пользователей, изменение личной информации и смена пароля.

- **Сервисы**:
  - `AuthService`: Обрабатывает логику аутентификации и управления пользователями.
  - `PasswordManager`: Управляет хешированием и проверкой паролей.
  - `JWTokenManager`: Генерирует и проверяет JWT-токены.

- **Репозитории**:
  - `AuthRepository`: Взаимодействует с базой данных для управления пользователями.
  - `TokenRepository`: Использует Redis для хранения refresh-токенов.

#### 1.2. Модуль `app`

- **Функциональность**: 
  - Основная логика приложения, работа с книгами, авторами и выдачами книг.

- **Основные API-маршруты**:
 - Достук к API добавления, удаления и обновления только для администраторов.  

  - `/authors`: Добавление, удаление, обновление и просмотр авторов (по ID или списка).
  - `/books`: Добавление, удаление, обновление и просмотр книг (по ID или списка). 
  - `/borrow`: Выдача, возврат и просмотр выдач (по ID, всего списка или для пользователя). Одновременно выдаваемых книг на одного читателя ограничено до 5.

- **Сервисы**:
  - `BookService`: Обрабатывает логику работы с книгами.
  - `AuthorService`: Управляет данными об авторах.
  - `BorrowService`: Обрабатывает логику выдачи книг.

- **Репозитории**:
  - `BookRepository`: Взаимодействует с базой данных для управления книгами.
  - `AuthorRepository`: Взаимодействует с базой данных для управления авторами.
  - `BorrowRepository`: Взаимодействует с базой данных для управления выдачами книг.

- **Пагинация и Фильтрация**: 
  - `limit`: Количество объектов для пагинации.
  - `offset`: Начальный индекс для пагинации.
  - `field` : Поле для фильтрации (если не указано или указано не верно то .
  - `value`: Значение для фильтрации (полнотекстовый поиск, если не указано то ищет по None).


#### 1.3. Модуль `core`

- **Функциональность**: 
  - Содержит настройки, базовые классы и функции, используемые в других модулях.

- **Компоненты**:
  - **База данных**: Управление сессиями и подключением к PostgreSQL и Redis.
  - 
  - **Сервисы**:
    - `BaseService`: Базовый класс для всех сервисов.
    - `PaginatedFetcher`: Обрабатывает пагинацию и фильтрацию данных.
    - 
  - **Репозитории**:
    - `BaseRepository`: Базовый класс для всех репозиториев.
    - `PaginatedFetcherRepository`: Репозиторий для работы с пагинацией.

### 2. Валидация и сериализация

Для валидации и десириализаци входных данных и сериализации выдаемых данных используется Pydantic.

### 3. Работа с базой данных

Приложение использует PostgreSQL для хранения данных о пользователях, книгах, авторах и выдачах книг, а также Redis для
хранения refresh-токенов. Каждый модуль взаимодействует с базой данных через свои репозитории.

### 4. Механизм авторизации

Для авторизации используется JWT (JSON Web Token). При успешной аутентификации пользователю выдается access-токен и в
cookie кладётся refresh-токен, по которому можно получить новую пару токенов.

### 5. Зависимости

Ендпоинты получают сервисы необходимые для обработки запроса через Depends зависимости, с интегрированными в них
репозиторием и другими сервисами, если они необходимы для обработки запроса.

### 6. Логирование

Логирование реализовано для всех событий изменения базы данных (create, update, delete) в app.

### 8. Контейнеризация:

Приложение, PostgreSQL и Redis запускаются в отдельных Docker-контейнерах. Сетевое взаимодействие между микросервисами
осуществляется через Docker Network.

## Тестирование

Приложение включает в себя модульные и интеграционные тесты, написанные с использованием
Pytest(fixture, AsyncMock, mock и dependency overrides).
Тесты запускаются в отдельном Docker-контейнере и имеют собственную базу данных.

Для запуска тестов введите команду из папки tests:
```sh
docker-compose up --build -d && docker-compose logs -f testapp
```

## Документация
Реализована встроенная FastAP OpenAPI документация.  

Ссылка на задачу:  
https://docs.google.com/document/d/1ej6Qdhf65VP6d8rPCti2wdiD680p91UKu6GQS7i-IKs/edit?hl=ru&tab=t.0


## Установка и Запуск
склонируте репозиторий:  
```sh
git clone https://github.com/AndreyLopanchuk/Library.git
```

Для запуска веб-приложения введите команду в корне проекта:  
```sh
docker-compose up --build
```
Пробросы томов на локальную машину закоментированы в docker-compose.yml
PostgreSQL, Redis и логирование сохраняют данные только в контейнере.

## Технологический стек
- PostgreSql - Основная база данных
- Redis - База данных для хранения refresh токенов
- Fastapi - фреймворк для разработки RESTful API
- Uvicorn - сервер для запуска FastAPI-приложения
- Pydantic - библиотека для работы с данными и валидации
- Sqlalchemy 2 - библиотека для работы с базой данных
- Pytest - фреймворк для написания и запуска тестов
- Docker - контейнеризация приложения, БД и тестов
- JWT - библиотека для работы с токенами
- bcrypt - библиотека для хеширования паролей
